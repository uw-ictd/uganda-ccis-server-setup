version: "3.3"

services: 
  db:
    image: postgres:9.6
    deploy:
      replicas: 1
    networks:
      - db-network
# ports:
#   - "5432:5432"
    volumes:
      - db-vol:/var/lib/postgresql/data
    env_file:
      - db.env
  db-bootstrap:
    image: odk/db-bootstrap
    deploy:
      replicas: 1
      restart_policy:
        condition: none
      placement:
        constraints:
          - node.role == manager
    networks:
      - db-network
      - sync-network
    volumes:
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
    env_file:
      - db.env
      - sync.env
  sync-3:
    image: odk/sync_endpoint
    networks: 
      - ldap-network
      - db-network
      - sync-network
    hostname: sync-3
    env_file:
      - sync.env
    secrets:
      - source: org.opendatakit.sync-3.security.properties
        target: org.opendatakit.aggregate.security.properties
      - source:  org.opendatakit.sync-3.jdbc.propertie
        target: org.opendatakit.aggregate.jdbc.properties
  web-ui-3:
    image: odk/sync-web-ui
    networks:
      - sync-network
    hostname: web-ui-3
    configs:
      - source: org.opendatakit.sync-web-ui-3.app.properties
        target: /org.opendatakit.sync-web-ui.application.properties

networks:
  ldap-network:
    external: 
       name: odk-x-ldap-network
  sync-network:
    external: 
       name: odk-x-sync-network
  db-network:
    driver: overlay
    driver_opts:
      encrypted: ""
    internal: true


volumes:
  db-vol: # preserve db

configs:
  org.opendatakit.sync-web-ui-3.app.properties:
    file: ./config/web-ui/application.properties.3

secrets:
  org.opendatakit.sync-3.security.properties:
    file: ./config/sync-endpoint/security.properties
  org.opendatakit.sync-3.jdbc.properties:
    file: ./config/sync-endpoint/jdbc.properties
